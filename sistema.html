<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Campanhas - CRUD + Dashboard Avançado</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #4cc9f0;
            --warning: #f72585;
            --danger: #ef4444;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        .dark-mode {
            --light: #121212;
            --dark: #f8f9fa;
            --gray-light: #2d2d2d;
            --gray: #adb5bd;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            transition: var(--transition);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--primary);
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            font-size: 2.5rem;
            color: var(--primary);
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .logo span {
            color: var(--primary);
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--box-shadow);
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--gray-light);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background-color: var(--gray);
            color: white;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* Tabs Navigation */
        .tabs {
            display: flex;
            background-color: var(--gray-light);
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            flex: 1;
            text-align: center;
            min-width: 140px;
        }

        .tab:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .tab.active {
            background-color: var(--primary);
            color: white;
        }

        /* Content Areas */
        .content-area {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .content-area.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Stats Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border-left: 4px solid var(--primary);
            transition: var(--transition);
            cursor: pointer;
        }

        .dark-mode .stat-card {
            background-color: var(--gray-light);
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
        }

        /* Charts Container */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }

        .chart-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            position: relative;
        }

        .dark-mode .chart-card {
            background-color: var(--gray-light);
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-wrapper {
            height: 400px;
            position: relative;
        }

        /* Campanhas List */
        .campanhas-container {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
        }

        .dark-mode .campanhas-container {
            background-color: var(--gray-light);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-box {
            position: relative;
            flex: 1;
            max-width: 400px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            background-color: var(--light);
            color: var(--dark);
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        /* Campanhas Grid */
        .campanhas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .campanha-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border: 1px solid var(--gray-light);
            transition: var(--transition);
            position: relative;
        }

        .dark-mode .campanha-card {
            background-color: var(--gray-light);
        }

        .campanha-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .campanha-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .campanha-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--dark);
        }

        .campanha-id {
            font-size: 0.8rem;
            color: var(--gray);
            background-color: var(--gray-light);
            padding: 3px 8px;
            border-radius: 10px;
        }

        .campanha-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-light);
        }

        .info-item {
            text-align: center;
        }

        .info-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
        }

        .info-label {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 3px;
        }

        .campanha-actions {
            display: flex;
            gap: 8px;
        }

        .campanha-actions .btn {
            flex: 1;
            justify-content: center;
            padding: 8px;
        }

        /* Form Container */
        .form-container {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--box-shadow);
            max-width: 800px;
            margin: 0 auto;
        }

        .dark-mode .form-container {
            background-color: var(--gray-light);
        }

        .form-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 25px;
            color: var(--primary);
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            background-color: var(--light);
            color: var(--dark);
            font-size: 0.95rem;
            transition: var(--transition);
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .form-help {
            font-size: 0.85rem;
            color: var(--gray);
            margin-top: 5px;
        }

        /* Itens List */
        .itens-container {
            margin-top: 30px;
        }

        .itens-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
        }

        .itens-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .item-card {
            background-color: var(--light);
            border-radius: var(--border-radius);
            padding: 15px;
            border: 1px solid var(--gray-light);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-title {
            font-weight: 600;
            color: var(--dark);
        }

        .item-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .item-detail {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .detail-value {
            font-weight: 600;
            color: var(--primary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .dark-mode .modal-content {
            background-color: var(--gray-light);
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }

        .loading i {
            font-size: 2rem;
            margin-bottom: 15px;
            color: var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 600;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
            box-shadow: var(--box-shadow);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success {
            background-color: var(--success);
        }

        .notification.error {
            background-color: var(--danger);
        }

        .notification.info {
            background-color: var(--primary);
        }

        /* Tabela de Detalhes */
        .details-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .details-table th {
            background-color: var(--primary);
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
        }

        .details-table td {
            padding: 10px 15px;
            border-bottom: 1px solid var(--gray-light);
        }

        .details-table tr:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .dark-mode .details-table tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .area-summary {
            margin: 15px 0;
            padding: 15px;
            background-color: var(--light);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary);
        }

        .area-summary h4 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .area-summary p {
            margin: 5px 0;
        }

        /* Chart Filters */
        .chart-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .chart-filter {
            padding: 8px 15px;
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            background-color: var(--light);
            color: var(--dark);
            cursor: pointer;
            transition: var(--transition);
        }

        .chart-filter:hover, .chart-filter.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .controls {
                width: 100%;
                justify-content: center;
            }
            
            .campanhas-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .chart-wrapper {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                <div>
                    <h1>Gestor de <span>Campanhas</span></h1>
                    <p>Sistema CRUD + Dashboard Avançado</p>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn btn-primary" id="btnNewCampaign">
                    <i class="fas fa-plus"></i> Nova Campanha
                </button>
                <button class="btn btn-secondary" id="btnRefresh">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
                <button class="btn btn-secondary" id="btnExport">
                    <i class="fas fa-download"></i> Exportar
                </button>
                <button class="btn btn-secondary" id="btnTheme">
                    <i class="fas fa-moon"></i> Tema
                </button>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs">
            <div class="tab active" data-tab="dashboard">
                <i class="fas fa-chart-bar"></i> Dashboard
            </div>
            <div class="tab" data-tab="campanhas">
                <i class="fas fa-bullhorn"></i> Campanhas
            </div>
            <div class="tab" data-tab="nova-campanha">
                <i class="fas fa-plus-circle"></i> Nova Campanha
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div class="content-area active" id="dashboard">
            <!-- Stats Cards Interativas -->
            <div class="stats-container" id="statsContainer">
                <!-- As estatísticas serão carregadas dinamicamente -->
            </div>

            <!-- Filtros para Gráficos -->
            <div class="chart-filters" id="chartFilters">
                <div class="chart-filter active" data-filter="all">Todas as Campanhas</div>
                <div class="chart-filter" data-filter="MÍDIA">Apenas MÍDIA</div>
                <div class="chart-filter" data-filter="PRODUÇÃO">Apenas PRODUÇÃO</div>
                <div class="chart-filter" data-filter="CRIAÇÃO">Apenas CRIAÇÃO</div>
            </div>

            <!-- Charts -->
            <div class="charts-container">
                <div class="chart-card">
                    <div class="chart-title">
                        <span>Valor por Campanha (Barras Agrupadas por Área)</span>
                        <button class="btn btn-small btn-secondary" id="toggleStacked">
                            <i class="fas fa-layer-group"></i> Alternar Visualização
                        </button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="chartCampaigns"></canvas>
                    </div>
                    <div class="chart-help" style="margin-top: 10px; font-size: 0.9rem; color: var(--gray);">
                        <i class="fas fa-mouse-pointer"></i> Clique em uma barra para ver os detalhes da campanha
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-title">
                        <span>Distribuição por Área (Total Geral)</span>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="chartAreas"></canvas>
                    </div>
                    <div class="chart-help" style="margin-top: 10px; font-size: 0.9rem; color: var(--gray);">
                        <i class="fas fa-mouse-pointer"></i> Clique em uma fatia para ver gastos detalhados da área
                    </div>
                </div>
            </div>

            <!-- Tabela de Detalhes (Aparece quando clica nos gráficos) -->
            <div class="chart-card" id="detailsTableContainer" style="display: none;">
                <div class="chart-title">
                    <span id="detailsTableTitle">Detalhes da Seleção</span>
                    <button class="btn btn-small btn-secondary" onclick="hideDetailsTable()">
                        <i class="fas fa-times"></i> Fechar
                    </button>
                </div>
                <div id="detailsTableContent">
                    <!-- Conteúdo será carregado dinamicamente -->
                </div>
            </div>
        </div>

        <!-- Campanhas List Tab -->
        <div class="content-area" id="campanhas">
            <div class="campanhas-container">
                <div class="section-header">
                    <h2>Todas as Campanhas</h2>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchCampaigns" placeholder="Buscar campanhas...">
                    </div>
                </div>
                
                <div class="campanhas-grid" id="campanhasList">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Carregando campanhas...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nova Campanha Tab -->
        <div class="content-area" id="nova-campanha">
            <div class="form-container">
                <div class="form-title">Nova Campanha</div>
                
                <div class="form-group">
                    <label class="form-label">Nome da Campanha *</label>
                    <input type="text" id="campaignName" class="form-input" placeholder="Ex: SHOW RURAL 2025">
                    <div class="form-help">Nome que será exibido na lista de campanhas</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ID da Campanha</label>
                    <div class="form-row">
                        <input type="text" id="campaignId" class="form-input" readonly>
                        <button type="button" class="btn btn-secondary" id="generateId">
                            <i class="fas fa-sync-alt"></i> Gerar Novo
                        </button>
                    </div>
                    <div class="form-help">ID único para identificação no sistema</div>
                </div>
                
                <!-- Itens da Campanha -->
                <div class="itens-container">
                    <div class="itens-header">
                        <h3>Itens da Campanha</h3>
                        <button type="button" class="btn btn-success btn-small" id="addItem">
                            <i class="fas fa-plus"></i> Adicionar Item
                        </button>
                    </div>
                    
                    <div class="itens-list" id="itemsListNew">
                        <!-- Itens serão adicionados aqui -->
                        <div class="empty-message">
                            Nenhum item adicionado. Clique em "Adicionar Item" para começar.
                        </div>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 30px;">
                    <div class="form-row">
                        <button type="button" class="btn btn-secondary" id="cancelNew">
                            Cancelar
                        </button>
                        <button type="button" class="btn btn-primary" id="saveCampaign">
                            <i class="fas fa-save"></i> Salvar Campanha
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-title">Confirmar Exclusão</div>
            <p>Tem certeza que deseja excluir esta campanha? Esta ação não pode ser desfeita.</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="modalCancel">Cancelar</button>
                <button class="btn btn-danger" id="modalConfirm">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Modal de Edição -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-title" id="editModalTitle">Editar Campanha</div>
            <div id="editModalContent">
                <!-- Conteúdo será carregado dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Item Template -->
    <template id="itemTemplate">
        <div class="item-card" data-index="{index}">
            <div class="item-header">
                <div class="item-title">Item {index}</div>
                <button type="button" class="btn btn-danger btn-small remove-item">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Área *</label>
                    <select class="form-select item-area">
                        <option value="">Selecione</option>
                        <option value="MÍDIA">MÍDIA</option>
                        <option value="PRODUÇÃO">PRODUÇÃO</option>
                        <option value="CRIAÇÃO">CRIAÇÃO</option>
                        <option value="OUTROS">OUTROS</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Serviço/Veículo *</label>
                    <input type="text" class="form-input item-service" placeholder="TV CULTURA GLOBO, Promotor, etc.">
                </div>
                <div class="form-group">
                    <label class="form-label">Valor (R$) *</label>
                    <input type="number" class="form-input item-value" step="0.01" min="0" placeholder="0,00">
                </div>
            </div>
        </div>
    </template>

    <!-- Campanha Card Template -->
    <template id="campaignTemplate">
        <div class="campanha-card" data-id="{id}">
            <div class="campanha-header">
                <div>
                    <div class="campanha-title">{nome}</div>
                    <div class="campanha-id">ID: {id}</div>
                </div>
                <div class="campanha-actions">
                    <button class="btn btn-primary btn-small btn-details" title="Ver Detalhes">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-success btn-small btn-edit" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger btn-small btn-delete" title="Excluir">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="campanha-info">
                <div class="info-item">
                    <div class="info-value">{itens}</div>
                    <div class="info-label">Itens</div>
                </div>
                <div class="info-item">
                    <div class="info-value">{valor}</div>
                    <div class="info-label">Valor Total</div>
                </div>
                <div class="info-item">
                    <div class="info-value">{media}</div>
                    <div class="info-label">Média/Item</div>
                </div>
            </div>
            <div style="margin-top: 10px; font-size: 0.85rem; color: var(--gray);">
                <i class="fas fa-layer-group"></i> Áreas: {areas}
            </div>
        </div>
    </template>

    <!-- Stats Card Template -->
    <template id="statTemplate">
        <div class="stat-card" data-area="{area}">
            <div class="stat-icon">
                <i class="{icon}"></i>
            </div>
            <div class="stat-value">{value}</div>
            <div class="stat-label">{label}</div>
        </div>
    </template>

    <script>
        // Configurações do Firebase
        const FIREBASE_URL = 'https://appatividades-7450d-default-rtdb.firebaseio.com/dadoscampanhas.json';
        
        // Estado global da aplicação
        const state = {
            campanhas: {},
            currentCampaignId: null,
            itemCounter: 1,
            chartFilter: 'all',
            stackedChart: true
        };

        // Formatadores
        const formatter = new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        });

        // Elementos DOM principais
        const elements = {
            tabs: document.querySelectorAll('.tab'),
            contentAreas: document.querySelectorAll('.content-area'),
            btnNewCampaign: document.getElementById('btnNewCampaign'),
            btnRefresh: document.getElementById('btnRefresh'),
            btnExport: document.getElementById('btnExport'),
            btnTheme: document.getElementById('btnTheme'),
            searchCampaigns: document.getElementById('searchCampaigns'),
            campanhasList: document.getElementById('campanhasList'),
            statsContainer: document.getElementById('statsContainer'),
            chartFilters: document.getElementById('chartFilters')
        };

        // Inicialização
        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            setupEventListeners();
            await loadCampaigns();
            setupCharts();
            setupTabs();
            generateNewId();
        }

        function setupEventListeners() {
            // Tabs
            elements.tabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            // Botões principais
            elements.btnNewCampaign.addEventListener('click', () => switchTab('nova-campanha'));
            elements.btnRefresh.addEventListener('click', loadCampaigns);
            elements.btnExport.addEventListener('click', exportData);
            elements.btnTheme.addEventListener('click', toggleTheme);

            // Busca
            elements.searchCampaigns.addEventListener('input', filterCampaigns);

            // Nova campanha
            document.getElementById('generateId').addEventListener('click', generateNewId);
            document.getElementById('addItem').addEventListener('click', addNewItem);
            document.getElementById('saveCampaign').addEventListener('click', saveCampaign);
            document.getElementById('cancelNew').addEventListener('click', () => switchTab('campanhas'));

            // Modal
            document.getElementById('modalCancel').addEventListener('click', hideModal);
            document.getElementById('modalConfirm').addEventListener('click', confirmDelete);

            // Filtros de gráficos
            document.querySelectorAll('.chart-filter').forEach(filter => {
                filter.addEventListener('click', () => {
                    document.querySelectorAll('.chart-filter').forEach(f => f.classList.remove('active'));
                    filter.classList.add('active');
                    state.chartFilter = filter.dataset.filter;
                    updateCharts();
                });
            });

            // Toggle stacked chart
            document.getElementById('toggleStacked').addEventListener('click', () => {
                state.stackedChart = !state.stackedChart;
                updateChartCampaigns();
                document.getElementById('toggleStacked').innerHTML = 
                    state.stackedChart ? 
                    '<i class="fas fa-chart-bar"></i> Modo Simples' : 
                    '<i class="fas fa-layer-group"></i> Modo Agrupado';
            });

            // Delegation para itens
            document.addEventListener('click', (e) => {
                // Remover item
                if (e.target.closest('.remove-item')) {
                    const itemCard = e.target.closest('.item-card');
                    itemCard.remove();
                    updateItemNumbers();
                }
                
                // Ver detalhes da campanha
                if (e.target.closest('.btn-details')) {
                    const card = e.target.closest('.campanha-card');
                    showCampaignDetails(card.dataset.id);
                }
                
                // Editar campanha
                if (e.target.closest('.btn-edit')) {
                    const card = e.target.closest('.campanha-card');
                    editCampaign(card.dataset.id);
                }
                
                // Excluir campanha
                if (e.target.closest('.btn-delete')) {
                    const card = e.target.closest('.campanha-card');
                    showDeleteModal(card.dataset.id);
                }
                
                // Clicar em stats card
                if (e.target.closest('.stat-card')) {
                    const card = e.target.closest('.stat-card');
                    const area = card.dataset.area;
                    if (area && area !== 'all') {
                        showAreaDetails(area);
                    }
                }
            });
        }

        function setupTabs() {
            switchTab('dashboard');
        }

        function switchTab(tabName) {
            // Atualizar tabs
            elements.tabs.forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });

            // Mostrar conteúdo correspondente
            elements.contentAreas.forEach(area => {
                area.classList.toggle('active', area.id === tabName);
            });

            // Ações específicas por tab
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'campanhas') {
                renderCampaignsList();
            } else if (tabName === 'nova-campanha') {
                resetNewCampaignForm();
            }
        }

        // Firebase Operations
        async function loadCampaigns() {
            try {
                showLoading(elements.campanhasList);
                
                const response = await fetch(FIREBASE_URL);
                const data = await response.json();
                
                state.campanhas = data || {};
                
                renderCampaignsList();
                updateDashboard();
                
                showNotification('Dados carregados com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao carregar campanhas:', error);
                showNotification('Erro ao carregar dados: ' + error.message, 'error');
            }
        }

        async function saveCampaignToFirebase(id, data) {
            try {
                const response = await fetch(
                    `https://appatividades-7450d-default-rtdb.firebaseio.com/dadoscampanhas/${id}.json`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    }
                );
                
                if (!response.ok) {
                    throw new Error('Erro ao salvar campanha');
                }
                
                return await response.json();
            } catch (error) {
                throw error;
            }
        }

        async function deleteCampaignFromFirebase(id) {
            try {
                const response = await fetch(
                    `https://appatividades-7450d-default-rtdb.firebaseio.com/dadoscampanhas/${id}.json`,
                    {
                        method: 'DELETE'
                    }
                );
                
                if (!response.ok) {
                    throw new Error('Erro ao excluir campanha');
                }
                
                return true;
            } catch (error) {
                throw error;
            }
        }

        // CRUD Operations
        function resetNewCampaignForm() {
            document.getElementById('campaignName').value = '';
            document.getElementById('itemsListNew').innerHTML = 
                '<div class="empty-message">Nenhum item adicionado. Clique em "Adicionar Item" para começar.</div>';
            generateNewId();
            state.itemCounter = 1;
        }

        function generateNewId() {
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substr(2, 5);
            document.getElementById('campaignId').value = `CAMP_${timestamp}_${random}`.toUpperCase();
        }

        function addNewItem() {
            const container = document.getElementById('itemsListNew');
            const template = document.getElementById('itemTemplate').content.cloneNode(true);
            const itemElement = template.querySelector('.item-card');
            
            // Remove mensagem de vazio
            const emptyMsg = container.querySelector('.empty-message');
            if (emptyMsg) emptyMsg.remove();
            
            // Atualiza índice
            const index = state.itemCounter++;
            itemElement.dataset.index = index;
            itemElement.querySelector('.item-title').textContent = `Item ${index}`;
            
            container.appendChild(itemElement);
        }

        function updateItemNumbers() {
            const container = document.getElementById('itemsListNew');
            const items = container.querySelectorAll('.item-card');
            
            items.forEach((item, index) => {
                item.dataset.index = index + 1;
                item.querySelector('.item-title').textContent = `Item ${index + 1}`;
            });
        }

        function collectItems(containerId) {
            const container = document.getElementById(containerId);
            const itemCards = container.querySelectorAll('.item-card');
            const items = [];
            
            itemCards.forEach(card => {
                const area = card.querySelector('.item-area').value;
                const service = card.querySelector('.item-service').value;
                const value = parseFloat(card.querySelector('.item-value').value) || 0;
                
                if (area && service && value > 0) {
                    items.push({
                        area: area,
                        servico: service,
                        valor: value
                    });
                }
            });
            
            return items;
        }

        async function saveCampaign() {
            const name = document.getElementById('campaignName').value.trim();
            const id = document.getElementById('campaignId').value.trim();
            const items = collectItems('itemsListNew');
            
            if (!name) {
                showNotification('Informe o nome da campanha', 'error');
                return;
            }
            
            if (items.length === 0) {
                showNotification('Adicione pelo menos um item à campanha', 'error');
                return;
            }
            
            try {
                const campaignData = {
                    campanha: name,
                    itens: items,
                    dataCriacao: new Date().toISOString()
                };
                
                await saveCampaignToFirebase(id, campaignData);
                
                showNotification('Campanha salva com sucesso!', 'success');
                loadCampaigns();
                switchTab('campanhas');
                resetNewCampaignForm();
                
            } catch (error) {
                showNotification('Erro ao salvar campanha: ' + error.message, 'error');
            }
        }

        function editCampaign(id) {
            if (!state.campanhas[id]) {
                showNotification('Campanha não encontrada', 'error');
                return;
            }
            
            const campanha = state.campanhas[id];
            let editHtml = `
                <div class="form-group">
                    <label class="form-label">Nome da Campanha</label>
                    <input type="text" id="editName" class="form-input" value="${campanha.campanha || ''}">
                </div>
                
                <div class="itens-container">
                    <div class="itens-header">
                        <h3>Itens da Campanha</h3>
                        <button type="button" class="btn btn-success btn-small" id="addEditItem">
                            <i class="fas fa-plus"></i> Adicionar Item
                        </button>
                    </div>
                    <div class="itens-list" id="editItemsList">
            `;
            
            // Adicionar itens existentes
            if (campanha.itens && Array.isArray(campanha.itens)) {
                campanha.itens.forEach((item, index) => {
                    editHtml += `
                        <div class="item-card" data-index="${index + 1}">
                            <div class="item-header">
                                <div class="item-title">Item ${index + 1}</div>
                                <button type="button" class="btn btn-danger btn-small remove-edit-item">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Área</label>
                                    <select class="form-select edit-item-area">
                                        <option value="MÍDIA" ${item.area === 'MÍDIA' ? 'selected' : ''}>MÍDIA</option>
                                        <option value="PRODUÇÃO" ${item.area === 'PRODUÇÃO' ? 'selected' : ''}>PRODUÇÃO</option>
                                        <option value="CRIAÇÃO" ${item.area === 'CRIAÇÃO' ? 'selected' : ''}>CRIAÇÃO</option>
                                        <option value="OUTROS" ${item.area === 'OUTROS' ? 'selected' : ''}>OUTROS</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Serviço</label>
                                    <input type="text" class="form-input edit-item-service" value="${item.servico || ''}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Valor (R$)</label>
                                    <input type="number" class="form-input edit-item-value" step="0.01" value="${item.valor || 0}">
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            editHtml += `
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 30px;">
                    <div class="form-row">
                        <button type="button" class="btn btn-secondary" id="cancelEdit">
                            Cancelar
                        </button>
                        <button type="button" class="btn btn-primary" id="saveEdit">
                            <i class="fas fa-save"></i> Salvar Alterações
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('editModalTitle').textContent = `Editar: ${campanha.campanha || id}`;
            document.getElementById('editModalContent').innerHTML = editHtml;
            document.getElementById('editModal').style.display = 'flex';
            
            // Configurar eventos do modal de edição
            document.getElementById('addEditItem').addEventListener('click', addEditItemModal);
            document.getElementById('saveEdit').addEventListener('click', () => saveEditCampaign(id));
            document.getElementById('cancelEdit').addEventListener('click', () => {
                document.getElementById('editModal').style.display = 'none';
            });
            
            // Delegation para remover itens no modal
            document.getElementById('editModalContent').addEventListener('click', (e) => {
                if (e.target.closest('.remove-edit-item')) {
                    e.target.closest('.item-card').remove();
                    updateEditItemNumbers();
                }
            });
        }

        function addEditItemModal() {
            const container = document.getElementById('editItemsList');
            const itemCount = container.querySelectorAll('.item-card').length;
            
            const newItem = `
                <div class="item-card" data-index="${itemCount + 1}">
                    <div class="item-header">
                        <div class="item-title">Item ${itemCount + 1}</div>
                        <button type="button" class="btn btn-danger btn-small remove-edit-item">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Área</label>
                            <select class="form-select edit-item-area">
                                <option value="MÍDIA">MÍDIA</option>
                                <option value="PRODUÇÃO">PRODUÇÃO</option>
                                <option value="CRIAÇÃO">CRIAÇÃO</option>
                                <option value="OUTROS">OUTROS</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Serviço</label>
                            <input type="text" class="form-input edit-item-service" placeholder="Digite o serviço...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Valor (R$)</label>
                            <input type="number" class="form-input edit-item-value" step="0.01" placeholder="0,00">
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', newItem);
        }

        function updateEditItemNumbers() {
            const container = document.getElementById('editItemsList');
            const items = container.querySelectorAll('.item-card');
            
            items.forEach((item, index) => {
                item.dataset.index = index + 1;
                item.querySelector('.item-title').textContent = `Item ${index + 1}`;
            });
        }

        async function saveEditCampaign(id) {
            const name = document.getElementById('editName').value.trim();
            const container = document.getElementById('editItemsList');
            const items = [];
            
            container.querySelectorAll('.item-card').forEach(card => {
                const area = card.querySelector('.edit-item-area').value;
                const service = card.querySelector('.edit-item-service').value;
                const value = parseFloat(card.querySelector('.edit-item-value').value) || 0;
                
                if (area && service && value > 0) {
                    items.push({
                        area: area,
                        servico: service,
                        valor: value
                    });
                }
            });
            
            if (!name) {
                showNotification('Informe o nome da campanha', 'error');
                return;
            }
            
            if (items.length === 0) {
                showNotification('A campanha deve ter pelo menos um item', 'error');
                return;
            }
            
            try {
                const campaignData = {
                    campanha: name,
                    itens: items,
                    dataAtualizacao: new Date().toISOString()
                };
                
                // Preservar data de criação
                if (state.campanhas[id] && state.campanhas[id].dataCriacao) {
                    campaignData.dataCriacao = state.campanhas[id].dataCriacao;
                }
                
                await saveCampaignToFirebase(id, campaignData);
                
                showNotification('Campanha atualizada com sucesso!', 'success');
                loadCampaigns();
                document.getElementById('editModal').style.display = 'none';
                
            } catch (error) {
                showNotification('Erro ao atualizar campanha: ' + error.message, 'error');
            }
        }

        function showDeleteModal(id) {
            state.currentCampaignId = id;
            document.getElementById('confirmModal').style.display = 'flex';
        }

        function hideModal() {
            document.getElementById('confirmModal').style.display = 'none';
            document.getElementById('editModal').style.display = 'none';
            state.currentCampaignId = null;
        }

        async function confirmDelete() {
            const id = state.currentCampaignId;
            
            try {
                await deleteCampaignFromFirebase(id);
                
                showNotification('Campanha excluída com sucesso!', 'success');
                loadCampaigns();
                hideModal();
                
            } catch (error) {
                showNotification('Erro ao excluir campanha: ' + error.message, 'error');
                hideModal();
            }
        }

        // Renderização
        function renderCampaignsList() {
            const container = elements.campanhasList;
            
            if (!state.campanhas || Object.keys(state.campanhas).length === 0) {
                container.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-inbox"></i>
                        <p>Nenhuma campanha cadastrada</p>
                        <button class="btn btn-primary" onclick="switchTab('nova-campanha')">
                            <i class="fas fa-plus"></i> Criar Primeira Campanha
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            Object.entries(state.campanhas).forEach(([id, campanha]) => {
                const nome = campanha.campanha || id;
                const itens = campanha.itens ? campanha.itens.length : 0;
                const valorTotal = campanha.itens ? 
                    campanha.itens.reduce((sum, item) => sum + (item.valor || 0), 0) : 0;
                const media = itens > 0 ? valorTotal / itens : 0;
                
                // Obter áreas únicas
                const areas = campanha.itens ? 
                    [...new Set(campanha.itens.map(item => item.area).filter(Boolean))].join(', ') : 
                    'Nenhuma';
                
                const template = document.getElementById('campaignTemplate').innerHTML;
                const cardHtml = template
                    .replace(/{id}/g, id)
                    .replace(/{nome}/g, nome.length > 30 ? nome.substring(0, 30) + '...' : nome)
                    .replace(/{itens}/g, itens)
                    .replace(/{valor}/g, formatter.format(valorTotal))
                    .replace(/{media}/g, formatter.format(media))
                    .replace(/{areas}/g, areas);
                
                html += cardHtml;
            });
            
            container.innerHTML = html;
        }

        function filterCampaigns() {
            const searchTerm = elements.searchCampaigns.value.toLowerCase();
            const cards = elements.campanhasList.querySelectorAll('.campanha-card');
            
            cards.forEach(card => {
                const title = card.querySelector('.campanha-title').textContent.toLowerCase();
                const id = card.querySelector('.campanha-id').textContent.toLowerCase();
                
                if (title.includes(searchTerm) || id.includes(searchTerm) || !searchTerm) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Dashboard
        function updateDashboard() {
            if (!state.campanhas) return;
            
            // Atualizar stats cards
            updateStatsCards();
            
            // Atualizar gráficos
            updateCharts();
        }

        function updateStatsCards() {
            const campanhasArray = Object.values(state.campanhas);
            const totalCampanhas = campanhasArray.length;
            
            // Calcular totais
            let totalItens = 0;
            let totalValue = 0;
            const areaTotals = {};
            
            campanhasArray.forEach(campanha => {
                const itens = campanha.itens || [];
                totalItens += itens.length;
                
                itens.forEach(item => {
                    const valor = item.valor || 0;
                    totalValue += valor;
                    
                    const area = item.area || 'OUTROS';
                    areaTotals[area] = (areaTotals[area] || 0) + valor;
                });
            });
            
            const avgValue = totalCampanhas > 0 ? totalValue / totalCampanhas : 0;
            
            // Renderizar stats cards
            let statsHtml = '';
            
            // Card Total Geral
            const template = document.getElementById('statTemplate').innerHTML;
            statsHtml += template
                .replace(/{area}/g, 'all')
                .replace(/{icon}/g, 'fas fa-bullhorn')
                .replace(/{value}/g, totalCampanhas)
                .replace(/{label}/g, 'Campanhas Ativas');
            
            // Card Total Itens
            statsHtml += template
                .replace(/{area}/g, 'all')
                .replace(/{icon}/g, 'fas fa-receipt')
                .replace(/{value}/g, totalItens)
                .replace(/{label}/g, 'Itens Cadastrados');
            
            // Card Valor Total
            statsHtml += template
                .replace(/{area}/g, 'all')
                .replace(/{icon}/g, 'fas fa-money-bill-wave')
                .replace(/{value}/g, formatter.format(totalValue))
                .replace(/{label}/g, 'Investimento Total');
            
            // Cards por Área (top 3 áreas)
            const topAreas = Object.entries(areaTotals)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3);
            
            topAreas.forEach(([area, value], index) => {
                const icons = ['fas fa-tv', 'fas fa-industry', 'fas fa-paint-brush'];
                statsHtml += template
                    .replace(/{area}/g, area)
                    .replace(/{icon}/g, icons[index] || 'fas fa-chart-pie')
                    .replace(/{value}/g, formatter.format(value))
                    .replace(/{label}/g, `Total em ${area}`);
            });
            
            elements.statsContainer.innerHTML = statsHtml;
        }

        function setupCharts() {
            // Inicializar gráficos
            window.charts = {
                campaigns: new Chart(document.getElementById('chartCampaigns'), {
                    type: 'bar',
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        onClick: (evt, elements) => {
                            if (elements.length > 0) {
                                const element = elements[0];
                                const datasetIndex = element.datasetIndex;
                                const index = element.index;
                                
                                // Obter dados do gráfico
                                const chart = window.charts.campaigns;
                                const label = chart.data.labels[index];
                                
                                // Encontrar campanha pelo nome
                                const campanhaEntry = Object.entries(state.campanhas).find(([id, camp]) => 
                                    (camp.campanha || id) === label
                                );
                                
                                if (campanhaEntry) {
                                    showCampaignDetailsTable(campanhaEntry[0], campanhaEntry[1]);
                                }
                            }
                        },
                        plugins: {
                            legend: { 
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${formatter.format(context.raw)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,
                                title: {
                                    display: true,
                                    text: 'Campanhas'
                                }
                            },
                            y: {
                                stacked: true,
                                title: {
                                    display: true,
                                    text: 'Valor (R$)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        if (value >= 1000000) {
                                            return 'R$ ' + (value / 1000000).toFixed(1) + 'M';
                                        }
                                        if (value >= 1000) {
                                            return 'R$ ' + (value / 1000).toFixed(0) + 'K';
                                        }
                                        return 'R$ ' + value;
                                    }
                                }
                            }
                        }
                    }
                }),
                areas: new Chart(document.getElementById('chartAreas'), {
                    type: 'pie',
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        onClick: (evt, elements) => {
                            if (elements.length > 0) {
                                const element = elements[0];
                                const index = element.index;
                                
                                const chart = window.charts.areas;
                                const label = chart.data.labels[index];
                                
                                showAreaDetails(label);
                            }
                        },
                        plugins: {
                            legend: { 
                                position: 'right',
                                labels: {
                                    padding: 20
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const valor = context.raw;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percent = ((valor / total) * 100).toFixed(1);
                                        return `${context.label}: ${formatter.format(valor)} (${percent}%)`;
                                    }
                                }
                            }
                        }
                    }
                })
            };
        }

        function updateCharts() {
            updateChartCampaigns();
            updateChartAreas();
        }

        function updateChartCampaigns() {
            if (!state.campanhas) return;
            
            // Filtrar campanhas baseado no filtro selecionado
            let campanhasFiltradas = Object.entries(state.campanhas);
            
            if (state.chartFilter !== 'all') {
                campanhasFiltradas = campanhasFiltradas.filter(([id, campanha]) => {
                    const itens = campanha.itens || [];
                    return itens.some(item => item.area === state.chartFilter);
                });
            }
            
            if (campanhasFiltradas.length === 0) {
                // Mostrar mensagem de nenhum dado
                window.charts.campaigns.data = {
                    labels: ['Nenhuma campanha encontrada'],
                    datasets: [{ data: [0], backgroundColor: '#ccc' }]
                };
                window.charts.campaigns.update();
                return;
            }
            
            // Obter todas as áreas únicas para as legendas
            const allAreas = new Set();
            campanhasFiltradas.forEach(([id, campanha]) => {
                const itens = campanha.itens || [];
                itens.forEach(item => {
                    if (item.area) allAreas.add(item.area);
                });
            });
            
            const areasArray = Array.from(allAreas);
            
            // Preparar dados para gráfico de barras agrupadas
            const labels = campanhasFiltradas.map(([id, campanha]) => 
                (campanha.campanha || id).substring(0, 25) + 
                ((campanha.campanha || id).length > 25 ? '...' : '')
            );
            
            // Criar datasets para cada área
            const datasets = areasArray.map((area, index) => {
                const colors = ['#4361ee', '#7209b7', '#4cc9f0', '#f72585', '#3a0ca3', '#4895ef', '#560bad'];
                const color = colors[index % colors.length];
                
                const data = campanhasFiltradas.map(([id, campanha]) => {
                    const itens = campanha.itens || [];
                    return itens
                        .filter(item => item.area === area)
                        .reduce((sum, item) => sum + (item.valor || 0), 0);
                });
                
                return {
                    label: area,
                    data: data,
                    backgroundColor: color,
                    borderColor: color,
                    borderWidth: 1,
                    stack: state.stackedChart ? 'stack' + (index % 2) : undefined
                };
            });
            
            window.charts.campaigns.data = {
                labels: labels,
                datasets: datasets
            };
            
            // Atualizar configuração de stacked
            window.charts.campaigns.options.scales.x.stacked = state.stackedChart;
            window.charts.campaigns.options.scales.y.stacked = state.stackedChart;
            
            window.charts.campaigns.update();
        }

        function updateChartAreas() {
            if (!state.campanhas) return;
            
            // Calcular totais por área
            const areaTotals = {};
            Object.values(state.campanhas).forEach(campanha => {
                const itens = campanha.itens || [];
                itens.forEach(item => {
                    const area = item.area || 'OUTROS';
                    areaTotals[area] = (areaTotals[area] || 0) + (item.valor || 0);
                });
            });
            
            // Ordenar por valor (maior primeiro)
            const sortedAreas = Object.entries(areaTotals)
                .sort((a, b) => b[1] - a[1]);
            
            const labels = sortedAreas.map(([area]) => area);
            const data = sortedAreas.map(([_, value]) => value);
            
            // Cores para o gráfico
            const colors = ['#4361ee', '#7209b7', '#4cc9f0', '#f72585', '#3a0ca3', '#4895ef', '#560bad'];
            
            window.charts.areas.data = {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors.slice(0, labels.length),
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            };
            
            window.charts.areas.update();
        }

        // Funções para mostrar detalhes
        function showCampaignDetailsTable(id, campanha) {
            const nome = campanha.campanha || id;
            const itens = campanha.itens || [];
            
            // Agrupar itens por área
            const itensPorArea = {};
            itens.forEach(item => {
                const area = item.area || 'OUTROS';
                if (!itensPorArea[area]) {
                    itensPorArea[area] = [];
                }
                itensPorArea[area].push(item);
            });
            
            let html = `
                <h3 style="color: var(--primary); margin-bottom: 20px;">${nome}</h3>
                <p><strong>ID:</strong> ${id}</p>
                <p><strong>Total de Itens:</strong> ${itens.length}</p>
            `;
            
            // Resumo por área
            Object.entries(itensPorArea).forEach(([area, itensArea]) => {
                const totalArea = itensArea.reduce((sum, item) => sum + (item.valor || 0), 0);
                const totalGeral = itens.reduce((sum, item) => sum + (item.valor || 0), 0);
                const percentual = ((totalArea / totalGeral) * 100).toFixed(1);
                
                html += `
                    <div class="area-summary">
                        <h4>${area}</h4>
                        <p><strong>Total Gastado:</strong> ${formatter.format(totalArea)}</p>
                        <p><strong>Percentual do Total:</strong> ${percentual}%</p>
                        <p><strong>Quantidade de Itens:</strong> ${itensArea.length}</p>
                    </div>
                `;
            });
            
            // Tabela detalhada
            html += `
                <table class="details-table">
                    <thead>
                        <tr>
                            <th>Área</th>
                            <th>Serviço/Veículo</th>
                            <th>Valor (R$)</th>
                            <th>% da Campanha</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const totalGeral = itens.reduce((sum, item) => sum + (item.valor || 0), 0);
            
            itens.forEach(item => {
                const percentual = totalGeral > 0 ? ((item.valor || 0) / totalGeral * 100).toFixed(1) : '0.0';
                html += `
                    <tr>
                        <td>${item.area || 'OUTROS'}</td>
                        <td>${item.servico || 'Não informado'}</td>
                        <td>${formatter.format(item.valor || 0)}</td>
                        <td>${percentual}%</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                <div style="margin-top: 20px; padding: 15px; background-color: var(--light); border-radius: var(--border-radius);">
                    <p style="font-weight: bold; color: var(--primary);">
                        <i class="fas fa-calculator"></i> Total Geral da Campanha: ${formatter.format(totalGeral)}
                    </p>
                </div>
            `;
            
            document.getElementById('detailsTableTitle').textContent = `Detalhes: ${nome}`;
            document.getElementById('detailsTableContent').innerHTML = html;
            document.getElementById('detailsTableContainer').style.display = 'block';
            
            // Scroll para a tabela
            document.getElementById('detailsTableContainer').scrollIntoView({ behavior: 'smooth' });
        }

        function showAreaDetails(area) {
            // Coletar todos os itens da área selecionada
            const itensArea = [];
            let totalArea = 0;
            
            Object.entries(state.campanhas).forEach(([id, campanha]) => {
                const itens = campanha.itens || [];
                itens.forEach(item => {
                    if (item.area === area) {
                        itensArea.push({
                            campanha: campanha.campanha || id,
                            campanhaId: id,
                            servico: item.servico,
                            valor: item.valor || 0
                        });
                        totalArea += item.valor || 0;
                    }
                });
            });
            
            if (itensArea.length === 0) {
                showNotification(`Nenhum item encontrado para a área: ${area}`, 'info');
                return;
            }
            
            // Ordenar por valor (maior primeiro)
            itensArea.sort((a, b) => b.valor - a.valor);
            
            let html = `
                <h3 style="color: var(--primary); margin-bottom: 20px;">
                    <i class="fas fa-chart-pie"></i> Detalhamento da Área: ${area}
                </h3>
                <div style="margin-bottom: 20px; padding: 15px; background-color: var(--light); border-radius: var(--border-radius);">
                    <p><strong>Total Gastado em ${area}:</strong> ${formatter.format(totalArea)}</p>
                    <p><strong>Quantidade de Itens:</strong> ${itensArea.length}</p>
                    <p><strong>Quantidade de Campanhas:</strong> ${[...new Set(itensArea.map(item => item.campanhaId))].length}</p>
                </div>
                
                <table class="details-table">
                    <thead>
                        <tr>
                            <th>Campanha</th>
                            <th>Serviço/Veículo</th>
                            <th>Valor (R$)</th>
                            <th>% da Área</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            itensArea.forEach(item => {
                const percentual = totalArea > 0 ? ((item.valor || 0) / totalArea * 100).toFixed(1) : '0.0';
                html += `
                    <tr onclick="showCampaignDetailsTable('${item.campanhaId}', state.campanhas['${item.campanhaId}'])" 
                        style="cursor: pointer;">
                        <td>${item.campanha}</td>
                        <td>${item.servico || 'Não informado'}</td>
                        <td>${formatter.format(item.valor || 0)}</td>
                        <td>${percentual}%</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                
                <div style="margin-top: 20px;">
                    <h4>Resumo por Campanha:</h4>
            `;
            
            // Agrupar por campanha
            const porCampanha = {};
            itensArea.forEach(item => {
                if (!porCampanha[item.campanhaId]) {
                    porCampanha[item.campanhaId] = {
                        nome: item.campanha,
                        total: 0,
                        itens: 0
                    };
                }
                porCampanha[item.campanhaId].total += item.valor;
                porCampanha[item.campanhaId].itens++;
            });
            
            // Converter para array e ordenar
            const campanhasArray = Object.entries(porCampanha)
                .sort((a, b) => b[1].total - a[1].total);
            
            campanhasArray.forEach(([id, dados]) => {
                const percentual = totalArea > 0 ? (dados.total / totalArea * 100).toFixed(1) : '0.0';
                html += `
                    <div class="area-summary" onclick="showCampaignDetailsTable('${id}', state.campanhas['${id}'])" 
                         style="cursor: pointer; margin-bottom: 10px;">
                        <p><strong>${dados.nome}:</strong> ${formatter.format(dados.total)} (${percentual}%)</p>
                        <p style="font-size: 0.9rem; color: var(--gray);">${dados.itens} itens</p>
                    </div>
                `;
            });
            
            html += `</div>`;
            
            document.getElementById('detailsTableTitle').textContent = `Detalhes da Área: ${area}`;
            document.getElementById('detailsTableContent').innerHTML = html;
            document.getElementById('detailsTableContainer').style.display = 'block';
            
            // Scroll para a tabela
            document.getElementById('detailsTableContainer').scrollIntoView({ behavior: 'smooth' });
        }

        function hideDetailsTable() {
            document.getElementById('detailsTableContainer').style.display = 'none';
        }

        function showCampaignDetails(id) {
            if (!state.campanhas[id]) {
                showNotification('Campanha não encontrada', 'error');
                return;
            }
            
            showCampaignDetailsTable(id, state.campanhas[id]);
            switchTab('dashboard');
        }

        // Utilitários
        function showLoading(element) {
            if (element) {
                element.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Carregando...</p>
                    </div>
                `;
            }
        }

        function showNotification(message, type = 'info') {
            // Remover notificações anteriores
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();
            
            // Criar nova notificação
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            // Remover após 5 segundos
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const icon = elements.btnTheme.querySelector('i');
            icon.className = document.body.classList.contains('dark-mode') ? 
                'fas fa-sun' : 'fas fa-moon';
        }

        async function exportData() {
            try {
                const dataStr = JSON.stringify(state.campanhas, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                
                const link = document.createElement('a');
                link.setAttribute('href', dataUri);
                link.setAttribute('download', `campanhas_${new Date().toISOString().split('T')[0]}.json`);
                link.click();
                
                showNotification('Dados exportados com sucesso!', 'success');
            } catch (error) {
                showNotification('Erro ao exportar dados: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>